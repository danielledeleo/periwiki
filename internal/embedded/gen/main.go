//go:build ignore

// Generator for embedded article metadata.
// Run via: go generate ./internal/embedded
package main

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"

	"github.com/go-git/go-git/v5"
	"golang.org/x/mod/modfile"
)

func main() {
	// Find repo root
	repoRoot, err := findRepoRoot(".")
	if err != nil {
		fmt.Fprintf(os.Stderr, "error finding repo root: %v\n", err)
		os.Exit(1)
	}

	// Parse go.mod for module path
	modData, err := os.ReadFile(filepath.Join(repoRoot, "go.mod"))
	if err != nil {
		fmt.Fprintf(os.Stderr, "error reading go.mod: %v\n", err)
		os.Exit(1)
	}
	modFile, err := modfile.Parse("go.mod", modData, nil)
	if err != nil {
		fmt.Fprintf(os.Stderr, "error parsing go.mod: %v\n", err)
		os.Exit(1)
	}

	// Get HEAD commit
	repo, err := git.PlainOpen(repoRoot)
	if err != nil {
		fmt.Fprintf(os.Stderr, "error opening git repo: %v\n", err)
		os.Exit(1)
	}
	head, err := repo.Head()
	if err != nil {
		fmt.Fprintf(os.Stderr, "error getting HEAD: %v\n", err)
		os.Exit(1)
	}
	commit := head.Hash().String()

	// Build base URL (GitHub only for now)
	baseURL := buildBaseURL(modFile.Module.Mod.Path, commit)

	// Generate output
	outputPath := filepath.Join(repoRoot, "internal", "embedded", "metadata_gen.go")
	if err := generateFile(outputPath, commit, baseURL); err != nil {
		fmt.Fprintf(os.Stderr, "error generating file: %v\n", err)
		os.Exit(1)
	}

	fmt.Printf("Generated %s (commit: %s)\n", outputPath, commit[:12])
}

func findRepoRoot(start string) (string, error) {
	dir, err := filepath.Abs(start)
	if err != nil {
		return "", err
	}
	for {
		if _, err := os.Stat(filepath.Join(dir, ".git")); err == nil {
			return dir, nil
		}
		parent := filepath.Dir(dir)
		if parent == dir {
			return "", fmt.Errorf(".git not found")
		}
		dir = parent
	}
}

func buildBaseURL(modulePath, commit string) string {
	// Only GitHub supported for now
	if strings.HasPrefix(modulePath, "github.com/") {
		return fmt.Sprintf("https://%s/blob/%s", modulePath, commit)
	}
	return ""
}

const tmpl = `// Code generated by go generate; DO NOT EDIT.

package embedded

// BuildCommit is the git commit hash at build time.
const BuildCommit = "{{.Commit}}"

// SourceBaseURL is the base URL for viewing source files.
// Empty if the forge couldn't be determined from go.mod.
const SourceBaseURL = "{{.BaseURL}}"
`

func generateFile(outputPath, commit, baseURL string) error {
	t, err := template.New("metadata").Parse(tmpl)
	if err != nil {
		return err
	}

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	return t.Execute(f, map[string]string{
		"Commit":  commit,
		"BaseURL": baseURL,
	})
}
